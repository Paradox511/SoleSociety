<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Sole Society</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
      <div id="header-container">
        <th:block th:if="${isLoggedIn}">
            <div th:replace="~{fragments/header-logged-in :: headerLoggedIn}"></div>
        </th:block>
        <th:block th:unless="${isLoggedIn}">
            <div th:replace="~{fragments/header-logged-out :: headerLoggedOut}"></div>
        </th:block>
    </div>
    <div th:replace="~{fragments/main-nav :: nav}"></div>

    <div class="main-content content-wrapper"> 
    	<h2>The Sole Society</h2>
<p>Is Logged In: <span th:text="${isLoggedIn}"></span></p>
       <div class="product-container" id="productContainer">
   			
	  </div>
        
    </div>

    <div th:replace="~{fragments/footer-fragment :: footer}"></div>
     <script>
        fetch('/api/products/getAll')
            .then(response => response.json())
            .then(products => {
                const productContainer = document.getElementById('productContainer');
                products.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.innerHTML = `
                        <div class="product-item">
                            <div class="product-image">
                                <img data-image="${product.imageUrls}" alt="${product.name}">
                            </div>
                            <div class="product-details">
                                <div class="product-title" data-name="${product.name}"></div>
                                <div class="product-lowest-ask">Lowest Ask</div>
                                <div class="product-price" data-price="${product.retailPrice}"></div>
                                <div class="product-ship">Xpress Ship</div>
                                <div class="product-brand" data-brand="${product.brand.name}"></div>
                                <div class="product-subcategory" data-subcategory="${product.subcategory.name}"></div>
                                <div class="product-type" data-type="${product.productType.name}"></div>
                                <div class="product-release-date" data-release="${product.releaseDate}"></div>
                                <div class="product-colorway" data-colorway="${product.colorway}"></div>
                                <div class="product-style-code" data-style-code="${product.styleCode}"></div>
                                <div class="product-size" data-size="${product.size}"></div>
                                <div class="product-status" data-status="${product.status}"></div>
                                <div class="product-quantity" data-quantity="${product.quantity}"></div>
                                <div class="product-discount" data-discount="${product.discount}"></div>
                            </div>
                            <button class="product-favorite" data-id="${product.productId}">â™¡</button>
                        </div>
                    `;

                    productItem.querySelector('.product-image img').src = productItem.querySelector('.product-image img').dataset.image;
                    productItem.querySelector('.product-title').textContent = productItem.querySelector('.product-title').dataset.name;
                    productItem.querySelector('.product-price').textContent = '$' + productItem.querySelector('.product-price').dataset.price;

                    productContainer.appendChild(productItem);
                });
            });
        fetch('/api/users/profile')
        .then(response => {
            if (response.ok) {
                return response.json();
            } else if (response.status === 401) {
                // User is not logged in or an error occurred
                console.log("User is not logged in or token is invalid.");
                // Redirect to login page or display a message
               // window.location.href = '/'; // Redirect to login
                return null; // Stop further processing
            } else {
                console.log("Response from /api/users/profile:", response); // Add this line
                // Handle other errors
                return null;
            }
        })
        .then(userData => {
            if (userData) {
                // Display the user data on the "/" page
                document.getElementById('user-welcome').textContent = 'Welcome, ' + userData.username + '!';
                console.log("Welcome" + userData.username);
            } else {
                // The user is not logged in or an error occurred.
                console.log("User is not logged in, or an error occurred.");
            }
        })
        .catch(error => {
            console.error('Error fetching user data:', error);
            // Handle the error (e.g., redirect to login)
        });
        document.addEventListener('DOMContentLoaded', function() {
            const logoutButton = document.getElementById('logoutButton');

            if (logoutButton) {
                logoutButton.addEventListener('click', function(event) {
                    event.preventDefault();

                    fetch('/api/users/logout', {
                        method: 'POST'
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = '/';
                        } else {
                            console.error('Logout failed');
                        }
                    })
                    .catch(error => {
                        console.error('Error during logout:', error);
                    });
                });
            }
        });
    </script>
</body>
</html>